generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Automation {
  id        String   @id
  userId    String
  name      String
  trigger   String
  action    String
  template  String
  enabled   Boolean  @default(true)
  config    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([enabled])
  @@index([trigger])
  @@index([userId])
}

model Lead {
  id        String      @id @default(cuid())
  userId    String
  name      String?
  email     String?
  phone     String?
  address   String?     // Full address for geocoding
  source    String?
  score     Int         @default(0)
  stage     String      @default("New")
  intent    String?
  sentiment String?
  notes     String?
  metadata  Json?
  
  // Solar Site Suitability Fields (from Google Solar API)
  roofPitch            Float?   // Slope of the roof in degrees
  maxPanelsCount       Int?     // Maximum number of solar panels possible
  maxSunshineHoursYear Float?   // Estimated annual sunlight hours
  annualKwhProduction  Float?   // Estimated annual energy production in kWh
  carbonOffsetKg       Float?   // Annual CO2 offset in kilograms
  siteSuitability      String?  // 'VIABLE', 'CHALLENGING', 'NOT_VIABLE'
  solarEnriched        Boolean  @default(false) // Flag indicating solar data fetched
  solarEnrichedAt      DateTime? // When solar data was last fetched
  
  // Relations
  siteSurvey  SiteSurvey?
  proposals   Proposal[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  User        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  LeadEvent   LeadEvent[]

  @@index([createdAt])
  @@index([score])
  @@index([stage])
  @@index([userId])
  @@index([siteSuitability])
}

// Detailed Solar Site Survey Data
// Stores comprehensive API response and system design
model SiteSurvey {
  id                String   @id @default(cuid())
  leadId            String   @unique
  
  // Location Data
  latitude          Float?
  longitude         Float?
  imageryDate       DateTime? // Date of satellite imagery
  imageryQuality    String?   // Quality of available imagery
  
  // Roof Analysis
  roofSegmentCount  Int?      // Number of distinct roof segments
  totalRoofAreaSqM  Float?    // Total roof area in square meters
  usableRoofAreaSqM Float?    // Usable area for panels
  azimuthDegrees    Float?    // Roof orientation (compass direction)
  
  // System Design
  systemSizeKW      Float?    // Designed system size in kW
  panelCapacityW    Int?      // Individual panel wattage
  recommendedPanels Int?      // Recommended number of panels
  
  // Financial Projections
  estimatedCostUsd     Float?   // Estimated installation cost
  estimatedSavingsYear Float?   // Annual savings estimate
  paybackYears         Float?   // Estimated payback period
  
  // Raw API Data
  buildingInsightsJson Json?    // Full buildingInsights response
  moduleLayoutJson     Json?    // Panel layout and segment data
  financialAnalysisJson Json?   // Financial analysis data
  
  // Imagery
  roofImageUrl      String?   // URL to roof satellite image
  dsm3dUrl          String?   // Digital Surface Model 3D URL
  
  // Metadata
  apiVersion        String?   // API version used
  requestId         String?   // API request ID for debugging
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  Lead              Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  @@index([leadId])
  @@index([systemSizeKW])
}

model LeadEvent {
  id        String   @id @default(cuid())
  leadId    String
  type      String
  content   String?
  metadata  Json?
  createdAt DateTime @default(now())
  Lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([type])
}

// ============================================================================
// PROPOSAL - Financial Proposals for Solar Installations
// ============================================================================

model Proposal {
  id        String   @id @default(cuid())
  leadId    String
  
  // System Specifications
  systemSizeWatts       Int       // Total system size in watts
  systemSizeKW          Float     // Total system size in kW
  panelCount            Int       // Number of panels
  panelWattage          Int       @default(400) // Individual panel wattage
  
  // Production Estimates
  annualProductionKWh   Float     // Year 1 estimated production
  lifetimeProductionKWh Float     // 25-year total production
  
  // Cost Breakdown
  grossSystemCost       Float     // Before incentives
  federalITC            Float     // Federal Investment Tax Credit amount
  stateRebate           Float     @default(0) // State/local rebates
  priceAfterITC         Float     // Final price after incentives
  costPerWatt           Float     // $/W after incentives
  
  // Savings Projections
  year1Savings          Float     // First year savings
  netSavings25Yr        Float     // Total net savings over 25 years
  breakEvenYear         Int?      // Year when system pays for itself
  
  // Financial Scenarios (JSON for flexibility)
  cashScenario          Json      // Cash purchase details
  loan10YearScenario    Json      // 10-year loan details
  loan15YearScenario    Json      // 15-year loan details
  ppaScenario           Json      // Power Purchase Agreement details
  recommendedOption     String    // CASH, LOAN_10, LOAN_15, or PPA
  
  // Assumptions Used
  utilityRate           Float     // $/kWh used for calculations
  utilityEscalation     Float     // Annual rate escalation %
  panelEfficiency       Float     // Panel efficiency %
  degradationRate       Float     // Annual degradation %
  
  // Metadata
  stateCode             String?   // State for utility rate lookup
  generatedAt           DateTime  @default(now())
  expiresAt             DateTime? // When proposal expires
  status                String    @default("draft") // draft, sent, viewed, accepted, expired
  
  // Secure Public Access Token
  accessToken           String    @unique @default(cuid()) // Secure token for public viewing
  
  // E-Signature & Acceptance
  signedAt              DateTime? // When proposal was signed
  signatureImage        String?   @db.Text // Base64 encoded signature image
  selectedScenario      String?   // Which scenario was selected (CASH, LOAN_10, LOAN_15, PPA)
  customerName          String?   // Name of person who signed
  customerEmail         String?   // Email for contract delivery
  ipAddress             String?   // IP address at signing (for audit)
  
  // Relations
  Lead                  Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  @@index([leadId])
  @@index([status])
  @@index([generatedAt])
  @@index([accessToken])
}

model User {
  id                     String       @id
  email                  String       @unique
  name                   String?
  clerkId                String       @unique
  stripeCustomer         String?      @unique
  subscriptionPlan       String?      @default("free")
  subscriptionStatus     String?
  subscriptionCurrentEnd DateTime?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime
  Automation             Automation[]
  Lead                   Lead[]

  @@index([clerkId])
  @@index([email])
}
